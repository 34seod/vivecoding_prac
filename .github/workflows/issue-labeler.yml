name: Issue Auto Labeler

on:
  issues:
    types: [opened, reopened, edited]

jobs:
  label:
    runs-on: ubuntu-latest

    steps:
      - name: Auto Label Issue
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = context.issue.number;
            const issueTitle = context.payload.issue.title;
            const issueBody = context.payload.issue.body || '';

            let labels = new Set();

            // Analyze title and body text
            const text = (issueTitle + ' ' + issueBody).toLowerCase();

            // Type-based labeling
            if (text.includes('[bug]') || text.includes('bug') || text.includes('error') ||
                text.includes('fail') || text.includes('broken') || text.includes('crash')) {
              labels.add('bug');
              labels.add('type/bug');
            }

            if (text.includes('[feature]') || text.includes('feature') || text.includes('add ') ||
                text.includes('implement') || text.includes('new ')) {
              labels.add('enhancement');
              labels.add('type/feature');
            }

            if (text.includes('[question]') || text.includes('question') || text.includes('help') ||
                text.includes('how to') || text.includes('how do')) {
              labels.add('question');
              labels.add('type/question');
            }

            if (text.includes('[docs]') || text.includes('documentation') || text.includes('readme') ||
                text.includes('guide') || text.includes('tutorial')) {
              labels.add('documentation');
              labels.add('type/documentation');
            }

            if (text.includes('enhancement') || text.includes('improve') || text.includes('optimize') ||
                text.includes('better') || text.includes('upgrade')) {
              labels.add('enhancement');
              labels.add('type/enhancement');
            }

            // Priority-based labeling
            if (text.includes('critical') || text.includes('urgent') || text.includes('production') ||
                text.includes('security') || text.includes('data loss')) {
              labels.add('priority/critical');
            } else if (text.includes('important') || text.includes('high priority') || text.includes('asap')) {
              labels.add('priority/high');
            } else if (text.includes('minor') || text.includes('low priority') || text.includes('nice to have')) {
              labels.add('priority/low');
            } else {
              labels.add('priority/medium'); // default priority
            }

            // Component-based labeling
            if (text.includes('backend') || text.includes('api') || text.includes('server') ||
                text.includes('database') || text.includes('fastapi') || text.includes('python')) {
              labels.add('component/backend');
            }

            if (text.includes('frontend') || text.includes('ui') || text.includes('ux') ||
                text.includes('interface') || text.includes('streamlit') || text.includes('web')) {
              labels.add('component/frontend');
            }

            if (text.includes('test') || text.includes('testing') || text.includes('pytest') ||
                text.includes('coverage') || text.includes('automation')) {
              labels.add('component/tests');
            }

            if (text.includes('docs') || text.includes('documentation') || text.includes('readme') ||
                text.includes('wiki') || text.includes('guide')) {
              labels.add('component/docs');
            }

            if (text.includes('ci') || text.includes('cd') || text.includes('deployment') ||
                text.includes('github actions') || text.includes('pipeline')) {
              labels.add('component/ci-cd');
            }

            // Complexity/Size labeling
            const wordCount = text.split(' ').length;
            if (wordCount < 50) {
              labels.add('size/small');
            } else if (wordCount < 150) {
              labels.add('size/medium');
            } else {
              labels.add('size/large');
            }

            // Status labeling
            labels.add('status/triaged');

            // Special condition labeling
            if (text.includes('security') || text.includes('vulnerability') || text.includes('exploit')) {
              labels.add('security');
            }

            if (text.includes('performance') || text.includes('slow') || text.includes('memory') ||
                text.includes('cpu') || text.includes('optimization')) {
              labels.add('performance');
            }

            if (text.includes('config') || text.includes('configuration') || text.includes('setting') ||
                text.includes('environment')) {
              labels.add('configuration');
            }

            if (text.includes('dependency') || text.includes('package') || text.includes('library') ||
                text.includes('requirements')) {
              labels.add('dependencies');
            }

            // OS/Platform specific
            if (text.includes('windows')) {
              labels.add('platform/windows');
            }
            if (text.includes('mac') || text.includes('macos')) {
              labels.add('platform/macos');
            }
            if (text.includes('linux')) {
              labels.add('platform/linux');
            }

            // Convert Set to Array
            const labelsArray = Array.from(labels);

            try {
              // Add labels to issue
              await github.rest.issues.addLabels({
                owner,
                repo,
                issue_number: issueNumber,
                labels: labelsArray
              });

              console.log(`Added labels to issue #${issueNumber}: ${labelsArray.join(', ')}`);

              // Add labeling notification comment
              const labelComment = `
              ## ğŸ·ï¸ ìë™ ë¼ë²¨ë§ ì™„ë£Œ

              ë‹¤ìŒ ë¼ë²¨ë“¤ì´ ìë™ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤:
              ${labelsArray.map(label => `- \`${label}\``).join('\n')}

              ### ğŸ¯ ë¼ë²¨ë§ ê¸°ì¤€
              - **íƒ€ì…**: ì œëª©ê³¼ ë‚´ìš©ì˜ í‚¤ì›Œë“œ ë¶„ì„
              - **ìš°ì„ ìˆœìœ„**: ê¸´ê¸‰ì„± í‚¤ì›Œë“œ ê²€ìƒ‰
              - **ì»´í¬ë„ŒíŠ¸**: ê´€ë ¨ ê¸°ìˆ /ì˜ì—­ í‚¤ì›Œë“œ ê²€ìƒ‰
              - **í¬ê¸°**: ì´ìŠˆ ì„¤ëª… ê¸¸ì´ ê¸°ë°˜ (${text.split(' ').length} ë‹¨ì–´)

              ### ğŸ“ ë¼ë²¨ ìˆ˜ì •
              ë¼ë²¨ì´ ë¶€ì •í™•í•œ ê²½ìš°:
              1. ìš°ì¸¡ ì‚¬ì´ë“œë°”ì˜ "Labels" ì„¹ì…˜ì—ì„œ ìˆ˜ì •
              2. ë¶€ì ì ˆí•œ ë¼ë²¨ ì œê±° ë˜ëŠ” ëˆ„ë½ëœ ë¼ë²¨ ì¶”ê°€
              3. ëŒ“ê¸€ë¡œ ë¼ë²¨ ë³€ê²½ ì´ìœ ë¥¼ ì„¤ëª… (ì„ íƒì‚¬í•­)

              ### ğŸ“‹ ì£¼ìš” ë¼ë²¨ ì˜ë¯¸
              - \`priority/*\`: ì²˜ë¦¬ ìš°ì„ ìˆœìœ„
              - \`type/*\`: ì´ìŠˆ ìœ í˜•
              - \`component/*\`: ê´€ë ¨ ì»´í¬ë„ŒíŠ¸/ì˜ì—­
              - \`size/*\`: ì´ìŠˆ ë³µì¡ë„/í¬ê¸°
              - \`status/*\`: í˜„ì¬ ì²˜ë¦¬ ìƒíƒœ

              ---
              *ì´ ë¼ë²¨ë“¤ì€ ìë™ìœ¼ë¡œ ì¶”ê°€ë˜ì—ˆìŠµë‹ˆë‹¤.*
              `;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: labelComment
              });

            } catch (error) {
              console.log(`Labeling error: ${error.message}`);

              // Add error comment
              const errorComment = `
              ## âš ï¸ ìë™ ë¼ë²¨ë§ ì‹¤íŒ¨

              ë¼ë²¨ ì¶”ê°€ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.

              ### ğŸ” ê°ì§€ëœ ì •ë³´
              - **ì¶”ì²œ ë¼ë²¨**: ${labelsArray.map(l => `\`${l}\``).join(', ')}
              - **ì˜¤ë¥˜**: ${error.message}

              í”„ë¡œì íŠ¸ ê´€ë¦¬ìê°€ ìˆ˜ë™ìœ¼ë¡œ ì ì ˆí•œ ë¼ë²¨ì„ ì¶”ê°€í•´ ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.

              ---
              *@project-maintainer ë‹˜, ì´ ì´ìŠˆì— ë¼ë²¨ì„ ì¶”ê°€í•´ ì£¼ì„¸ìš”.*
              `;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: errorComment
              });
            }
