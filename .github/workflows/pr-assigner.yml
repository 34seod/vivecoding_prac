name: PR Auto Assigner

on:
  pull_request:
    types: [opened, reopened]

jobs:
  assign:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Assign Reviewers
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.issue.number;
            const author = context.payload.pull_request.user.login;

            // Get files changed in the PR
            const { data: files } = await github.rest.pulls.listFiles({
              owner,
              repo,
              pull_number: prNumber
            });

            // Define code owners based on file paths
            const codeOwners = {
              'backend/': ['backend-team-lead'],
              'frontend/': ['frontend-team-lead'],
              'docs/': ['docs-maintainer'],
              '.github/': ['devops-lead'],
              'tests/': ['qa-lead']
            };

            // Default reviewers (adjust as needed)
            const defaultReviewers = ['project-maintainer'];

            let reviewers = new Set(defaultReviewers);
            let assignees = new Set([author]);

            // Add reviewers based on changed files
            files.forEach(file => {
              const filePath = file.filename;
              Object.entries(codeOwners).forEach(([path, owners]) => {
                if (filePath.startsWith(path)) {
                  owners.forEach(owner => {
                    if (owner !== author) {
                      reviewers.add(owner);
                    }
                  });
                }
              });
            });

            // Convert Sets to Arrays and filter out non-existent users
            const reviewersList = Array.from(reviewers).filter(user => user !== author);
            const assigneesList = Array.from(assignees);

            try {
              // Assign reviewers
              if (reviewersList.length > 0) {
                await github.rest.pulls.requestReviewers({
                  owner,
                  repo,
                  pull_number: prNumber,
                  reviewers: reviewersList
                });

                console.log(`Assigned reviewers: ${reviewersList.join(', ')}`);
              }

              // Assign assignees
              await github.rest.issues.addAssignees({
                owner,
                repo,
                issue_number: prNumber,
                assignees: assigneesList
              });

              console.log(`Assigned assignees: ${assigneesList.join(', ')}`);

              // Add assignment comment
              const assignmentComment = `
              ## ðŸ‘¥ ìžë™ í• ë‹¹ ì™„ë£Œ

              ### í• ë‹¹ëœ ë¦¬ë·°ì–´
              ${reviewersList.map(reviewer => `- @${reviewer}`).join('\n')}

              ### í• ë‹¹ëœ ë‹´ë‹¹ìž
              ${assigneesList.map(assignee => `- @${assignee}`).join('\n')}

              ë³€ê²½ëœ íŒŒì¼ ê²½ë¡œë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì ì ˆí•œ ë¦¬ë·°ì–´ê°€ ìžë™ í• ë‹¹ë˜ì—ˆìŠµë‹ˆë‹¤.
              ì¶”ê°€ ë¦¬ë·°ì–´ê°€ í•„ìš”í•œ ê²½ìš° ìˆ˜ë™ìœ¼ë¡œ ì¶”ê°€í•´ ì£¼ì„¸ìš”.

              ---
              *ì´ í• ë‹¹ì€ ìžë™ìœ¼ë¡œ ìˆ˜í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.*
              `;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: assignmentComment
              });

            } catch (error) {
              console.log(`Assignment error: ${error.message}`);

              // Add error comment
              const errorComment = `
              ## âš ï¸ ìžë™ í• ë‹¹ ì‹¤íŒ¨

              ì¼ë¶€ ì‚¬ìš©ìžë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ìžë™ í• ë‹¹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.
              ìˆ˜ë™ìœ¼ë¡œ ë¦¬ë·°ì–´ë¥¼ í• ë‹¹í•´ ì£¼ì„¸ìš”.

              ë³€ê²½ëœ íŒŒì¼ ê²½ë¡œ:
              ${files.map(file => `- \`${file.filename}\``).join('\n')}
              `;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: prNumber,
                body: errorComment
              });
            }
