name: PR Auto Review

on:
  pull_request:
    types: [opened, synchronize]

jobs:
  auto-review:
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: "3.11"

      - name: Install dependencies
        run: |
          pip install flake8 black isort bandit safety mypy

      - name: Run Code Quality Checks
        id: quality-check
        run: |
          echo "## ğŸ” ìë™ ì½”ë“œ ë¦¬ë·° ê²°ê³¼" > review_results.md
          echo "" >> review_results.md

          # Flake8 linting
          echo "### ğŸ“ ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ (Flake8)" >> review_results.md
          if flake8 backend/ --max-line-length=88 --extend-ignore=E203,W503 > flake8_results.txt 2>&1; then
            echo "âœ… ì½”ë“œ ìŠ¤íƒ€ì¼ ê²€ì‚¬ í†µê³¼" >> review_results.md
          else
            echo "âŒ ì½”ë“œ ìŠ¤íƒ€ì¼ ë¬¸ì œ ë°œê²¬:" >> review_results.md
            echo '```' >> review_results.md
            head -20 flake8_results.txt >> review_results.md
            echo '```' >> review_results.md
          fi
          echo "" >> review_results.md

          # Black formatting check
          echo "### ğŸ¨ ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬ (Black)" >> review_results.md
          if black --check backend/ > black_results.txt 2>&1; then
            echo "âœ… ì½”ë“œ í¬ë§·íŒ… ê²€ì‚¬ í†µê³¼" >> review_results.md
          else
            echo "âŒ ì½”ë“œ í¬ë§·íŒ… ë¬¸ì œ ë°œê²¬:" >> review_results.md
            echo '```' >> review_results.md
            head -10 black_results.txt >> review_results.md
            echo '```' >> review_results.md
            echo "" >> review_results.md
            echo "ğŸ’¡ í•´ê²° ë°©ë²•: \`black backend/\` ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”." >> review_results.md
          fi
          echo "" >> review_results.md

          # Import sorting check
          echo "### ğŸ“¦ Import ì •ë ¬ ê²€ì‚¬ (isort)" >> review_results.md
          if isort --check-only backend/ > isort_results.txt 2>&1; then
            echo "âœ… Import ì •ë ¬ ê²€ì‚¬ í†µê³¼" >> review_results.md
          else
            echo "âŒ Import ì •ë ¬ ë¬¸ì œ ë°œê²¬:" >> review_results.md
            echo "ğŸ’¡ í•´ê²° ë°©ë²•: \`isort backend/\` ëª…ë ¹ì–´ë¥¼ ì‹¤í–‰í•˜ì„¸ìš”." >> review_results.md
          fi
          echo "" >> review_results.md

          # Security check
          echo "### ğŸ”’ ë³´ì•ˆ ê²€ì‚¬ (Bandit)" >> review_results.md
          if bandit -r backend/ -f json -o bandit_results.json > /dev/null 2>&1; then
            if [ -s bandit_results.json ] && [ "$(jq '.results | length' bandit_results.json 2>/dev/null || echo 0)" -gt 0 ]; then
              echo "âš ï¸ ë³´ì•ˆ ì´ìŠˆ ë°œê²¬:" >> review_results.md
              echo "ìì„¸í•œ ë‚´ìš©ì€ ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”." >> review_results.md
            else
              echo "âœ… ë³´ì•ˆ ê²€ì‚¬ í†µê³¼" >> review_results.md
            fi
          else
            echo "â“ ë³´ì•ˆ ê²€ì‚¬ ì‹¤í–‰ ì‹¤íŒ¨" >> review_results.md
          fi
          echo "" >> review_results.md

          # Dependency check
          echo "### ğŸ“‹ ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬ (Safety)" >> review_results.md
          if safety check --json > safety_results.json 2>&1; then
            echo "âœ… ì˜ì¡´ì„± ë³´ì•ˆ ê²€ì‚¬ í†µê³¼" >> review_results.md
          else
            echo "âš ï¸ ì·¨ì•½í•œ ì˜ì¡´ì„± ë°œê²¬:" >> review_results.md
            if [ -f safety_results.json ]; then
              echo "ìì„¸í•œ ë‚´ìš©ì€ ë³´ì•ˆ ê²€ì‚¬ ê²°ê³¼ë¥¼ í™•ì¸í•˜ì„¸ìš”." >> review_results.md
            fi
          fi
          echo "" >> review_results.md

      - name: Get PR Files
        uses: actions/github-script@v7
        id: pr-files
        with:
          script: |
            const { owner, repo } = context.repo;
            const prNumber = context.issue.number;

            const { data: files } = await github.rest.pulls.listFiles({
              owner,
              repo,
              pull_number: prNumber
            });

            return files;

      - name: Analyze Code Changes
        uses: actions/github-script@v7
        with:
          script: |
            const fs = require('fs');
            const { owner, repo } = context.repo;
            const prNumber = context.issue.number;

            // Read quality check results
            let reviewContent = '';
            try {
              reviewContent = fs.readFileSync('review_results.md', 'utf8');
            } catch (error) {
              reviewContent = '## ğŸ” ìë™ ì½”ë“œ ë¦¬ë·° ê²°ê³¼\n\nâŒ ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ì‹¤í–‰ ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.';
            }

            // Get PR files data
            const files = JSON.parse('${{ steps.pr-files.outputs.result }}');

            // Add file analysis
            reviewContent += '\n### ğŸ“ ë³€ê²½ëœ íŒŒì¼ ë¶„ì„\n\n';

            let hasTests = false;
            let hasDocumentation = false;
            let backendChanges = false;
            let frontendChanges = false;

            files.forEach(file => {
              const filename = file.filename;
              if (filename.includes('test')) hasTests = true;
              if (filename.endsWith('.md')) hasDocumentation = true;
              if (filename.startsWith('backend/')) backendChanges = true;
              if (filename.startsWith('frontend/')) frontendChanges = true;

              reviewContent += `- \`${filename}\` (+${file.additions}/-${file.deletions})\n`;
            });

            reviewContent += '\n### ğŸ“‹ ë¦¬ë·° ì²´í¬í¬ì¸íŠ¸\n\n';

            // Backend specific checks
            if (backendChanges) {
              reviewContent += '#### Backend ë³€ê²½ì‚¬í•­\n';
              reviewContent += hasTests ? 'âœ… í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤.\n' : 'âŒ í…ŒìŠ¤íŠ¸ íŒŒì¼ì´ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤. ìƒˆë¡œìš´ ê¸°ëŠ¥ì´ë‚˜ ë³€ê²½ì‚¬í•­ì— ëŒ€í•œ í…ŒìŠ¤íŠ¸ë¥¼ ì¶”ê°€í•´ì£¼ì„¸ìš”.\n';
              reviewContent += '- [ ] API ì—”ë“œí¬ì¸íŠ¸ ë³€ê²½ ì‹œ ë¬¸ì„œ ì—…ë°ì´íŠ¸ í™•ì¸\n';
              reviewContent += '- [ ] ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆ ë³€ê²½ ì‹œ ë§ˆì´ê·¸ë ˆì´ì…˜ ìŠ¤í¬ë¦½íŠ¸ í™•ì¸\n';
              reviewContent += '- [ ] í™˜ê²½ë³€ìˆ˜ ì¶”ê°€ ì‹œ .env.example ì—…ë°ì´íŠ¸ í™•ì¸\n\n';
            }

            // Frontend specific checks
            if (frontendChanges) {
              reviewContent += '#### Frontend ë³€ê²½ì‚¬í•­\n';
              reviewContent += '- [ ] UI/UX ë³€ê²½ ì‹œ ìŠ¤í¬ë¦°ìƒ· ë˜ëŠ” ë°ëª¨ í™•ì¸\n';
              reviewContent += '- [ ] ë°˜ì‘í˜• ë””ìì¸ ê³ ë ¤ í™•ì¸\n';
              reviewContent += '- [ ] ì ‘ê·¼ì„± ê°€ì´ë“œë¼ì¸ ì¤€ìˆ˜ í™•ì¸\n\n';
            }

            // General checks
            reviewContent += '#### ì¼ë°˜ ì²´í¬í¬ì¸íŠ¸\n';
            reviewContent += hasDocumentation ? 'âœ… ë¬¸ì„œê°€ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤.\n' : 'â“ ë¬¸ì„œ ì—…ë°ì´íŠ¸ê°€ í•„ìš”í•œì§€ í™•ì¸í•´ì£¼ì„¸ìš”.\n';
            reviewContent += '- [ ] ì½”ë“œì— ì¶©ë¶„í•œ ì£¼ì„ì´ í¬í•¨ë˜ì–´ ìˆëŠ”ê°€?\n';
            reviewContent += '- [ ] ì˜ˆì™¸ ì²˜ë¦¬ê°€ ì ì ˆíˆ êµ¬í˜„ë˜ì–´ ìˆëŠ”ê°€?\n';
            reviewContent += '- [ ] ì„±ëŠ¥ì— ì˜í–¥ì„ ì£¼ëŠ” ë³€ê²½ì‚¬í•­ì´ ìˆëŠ”ê°€?\n';
            reviewContent += '- [ ] ë³´ì•ˆ ì·¨ì•½ì ì€ ì—†ëŠ”ê°€?\n\n';

            reviewContent += '---\n*ì´ ë¦¬ë·°ëŠ” ìë™ìœ¼ë¡œ ìƒì„±ë˜ì—ˆìŠµë‹ˆë‹¤. ì¶”ê°€ì ì¸ ìˆ˜ë™ ë¦¬ë·°ê°€ í•„ìš”í•©ë‹ˆë‹¤.*';

            // Post review comment
            await github.rest.issues.createComment({
              owner,
              repo,
              issue_number: prNumber,
              body: reviewContent
            });

            console.log('Auto review comment posted successfully');
