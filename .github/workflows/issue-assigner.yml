name: Issue Auto Assigner

on:
  issues:
    types: [opened, reopened]

jobs:
  assign:
    runs-on: ubuntu-latest

    steps:
      - name: Assign Issue
        uses: actions/github-script@v7
        with:
          script: |
            const { owner, repo } = context.repo;
            const issueNumber = context.issue.number;
            const issueTitle = context.payload.issue.title;
            const issueBody = context.payload.issue.body || '';
            const author = context.payload.issue.user.login;

            // Define assignee mapping based on issue type and keywords
            const assigneeMapping = {
              // Component-based assignment
              'backend': ['backend-maintainer'],
              'frontend': ['frontend-maintainer'],
              'api': ['backend-maintainer'],
              'database': ['backend-maintainer'],
              'ui': ['frontend-maintainer'],
              'ux': ['frontend-maintainer'],
              'docs': ['docs-maintainer'],
              'documentation': ['docs-maintainer'],
              'ci': ['devops-maintainer'],
              'cd': ['devops-maintainer'],
              'deployment': ['devops-maintainer'],
              'security': ['security-maintainer'],
              'performance': ['backend-maintainer'],
              'test': ['qa-maintainer'],
              'testing': ['qa-maintainer']
            };

            // Default assignees for different issue types
            const defaultAssignees = {
              'bug': ['project-maintainer'],
              'feature': ['product-manager'],
              'enhancement': ['product-manager'],
              'question': ['community-manager'],
              'documentation': ['docs-maintainer']
            };

            let assignees = new Set();
            let issueType = 'general';

            // Analyze issue title and body for keywords
            const text = (issueTitle + ' ' + issueBody).toLowerCase();

            // Determine issue type
            if (text.includes('[bug]') || text.includes('bug') || text.includes('error') || text.includes('fail')) {
              issueType = 'bug';
            } else if (text.includes('[feature]') || text.includes('feature') || text.includes('enhancement')) {
              issueType = 'feature';
            } else if (text.includes('[question]') || text.includes('question') || text.includes('help')) {
              issueType = 'question';
            } else if (text.includes('[docs]') || text.includes('documentation')) {
              issueType = 'documentation';
            }

            // Add default assignees based on issue type
            if (defaultAssignees[issueType]) {
              defaultAssignees[issueType].forEach(assignee => assignees.add(assignee));
            } else {
              assignees.add('project-maintainer'); // fallback
            }

            // Add component-specific assignees
            Object.entries(assigneeMapping).forEach(([keyword, maintainers]) => {
              if (text.includes(keyword)) {
                maintainers.forEach(maintainer => assignees.add(maintainer));
              }
            });

            // Add author as assignee if they are not external contributor
            // (You can modify this logic based on your team structure)
            assignees.add(author);

            // Convert Set to Array and filter out duplicates
            const assigneesList = Array.from(assignees);

            try {
              // Assign the issue
              await github.rest.issues.addAssignees({
                owner,
                repo,
                issue_number: issueNumber,
                assignees: assigneesList
              });

              console.log(`Assigned issue #${issueNumber} to: ${assigneesList.join(', ')}`);

              // Add assignment notification comment
              const assignmentComment = `
              ## ğŸ‘¤ ìë™ í• ë‹¹ ì™„ë£Œ

              ### í• ë‹¹ëœ ë‹´ë‹¹ì
              ${assigneesList.map(assignee => `- @${assignee}`).join('\n')}

              ### í• ë‹¹ ê¸°ì¤€
              - **ì´ìŠˆ íƒ€ì…**: \`${issueType}\`
              - **ê°ì§€ëœ í‚¤ì›Œë“œ**: ${Object.keys(assigneeMapping).filter(keyword => text.includes(keyword)).map(k => `\`${k}\``).join(', ') || 'ì—†ìŒ'}

              ### ğŸ’¡ í• ë‹¹ ë³€ê²½
              ë‹´ë‹¹ìê°€ ì ì ˆí•˜ì§€ ì•Šë‹¤ë©´:
              1. ìš°ì¸¡ ì‚¬ì´ë“œë°”ì—ì„œ "Assignees" ì„¹ì…˜ì„ í´ë¦­
              2. ì ì ˆí•œ ë‹´ë‹¹ìë¡œ ë³€ê²½í•˜ê±°ë‚˜ ì¶”ê°€
              3. í•„ìš”ì‹œ ëŒ“ê¸€ë¡œ @ë©˜ì…˜í•˜ì—¬ ì•Œë¦¼

              ### ğŸ“… ì˜ˆìƒ ì‘ë‹µ ì‹œê°„
              - **Bug**: 24ì‹œê°„ ë‚´ ì²« ì‘ë‹µ
              - **Feature/Enhancement**: 72ì‹œê°„ ë‚´ ì²« ì‘ë‹µ
              - **Question**: 48ì‹œê°„ ë‚´ ì²« ì‘ë‹µ
              - **Documentation**: 72ì‹œê°„ ë‚´ ì²« ì‘ë‹µ

              ---
              *ì´ í• ë‹¹ì€ ìë™ìœ¼ë¡œ ìˆ˜í–‰ë˜ì—ˆìŠµë‹ˆë‹¤.*
              `;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: assignmentComment
              });

            } catch (error) {
              console.log(`Assignment error: ${error.message}`);

              // Add error notification
              const errorComment = `
              ## âš ï¸ ìë™ í• ë‹¹ ì‹¤íŒ¨

              ì¼ë¶€ ì‚¬ìš©ìë¥¼ ì°¾ì„ ìˆ˜ ì—†ì–´ ìë™ í• ë‹¹ì— ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.

              ### ğŸ“‹ ê°ì§€ëœ ì •ë³´
              - **ì´ìŠˆ íƒ€ì…**: \`${issueType}\`
              - **ì‹œë„í•œ í• ë‹¹**: ${assigneesList.map(a => `@${a}`).join(', ')}

              í”„ë¡œì íŠ¸ ê´€ë¦¬ìê°€ ìˆ˜ë™ìœ¼ë¡œ ì ì ˆí•œ ë‹´ë‹¹ìë¥¼ í• ë‹¹í•´ ë“œë¦´ ì˜ˆì •ì…ë‹ˆë‹¤.

              ---
              *@project-maintainer ë‹˜, ì´ ì´ìŠˆì— ë‹´ë‹¹ìë¥¼ í• ë‹¹í•´ ì£¼ì„¸ìš”.*
              `;

              await github.rest.issues.createComment({
                owner,
                repo,
                issue_number: issueNumber,
                body: errorComment
              });
            }
